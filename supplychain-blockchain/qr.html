<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Produce Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 2rem;
    }
    .card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 500px;
      margin: auto;
    }
    h2 {
      margin-top: 0;
      color: #2c3e50;
    }
    .field {
      margin: 0.5rem 0;
    }
    .label {
      font-weight: bold;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Produce Details</h2>
    <div id="output">Loading...</div>
  </div>

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // === Replace with your deployed contract info ===
    const contractAddress = "0xcCeD24c53583094aA92D924f9e2128252cd6287a";
    const contractABI = [
  {
    anonymous: false,
    inputs: [
      {
        indexed: true,
        internalType: "uint256",
        name: "produceId",
        type: "uint256",
      },
      {
        indexed: false,
        internalType: "string",
        name: "crop",
        type: "string",
      },
      {
        indexed: false,
        internalType: "uint256",
        name: "quantity",
        type: "uint256",
      },
    ],
    name: "ProduceAdded",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: true,
        internalType: "uint256",
        name: "produceId",
        type: "uint256",
      },
      {
        indexed: true,
        internalType: "address",
        name: "to",
        type: "address",
      },
    ],
    name: "ProduceTransferred",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: true,
        internalType: "address",
        name: "user",
        type: "address",
      },
      {
        indexed: false,
        internalType: "enum AgriSupplyChain.Role",
        name: "role",
        type: "uint8",
      },
    ],
    name: "Registered",
    type: "event",
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "produceId",
        type: "uint256",
      },
      {
        internalType: "string",
        name: "crop",
        type: "string",
      },
      {
        internalType: "uint256",
        name: "quantity",
        type: "uint256",
      },
      {
        internalType: "string",
        name: "quality",
        type: "string",
      },
      {
        internalType: "string",
        name: "date",
        type: "string",
      },
    ],
    name: "addProduce",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "address",
        name: "",
        type: "address",
      },
    ],
    name: "agents",
    outputs: [
      {
        internalType: "string",
        name: "name",
        type: "string",
      },
      {
        internalType: "string",
        name: "location",
        type: "string",
      },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "address",
        name: "",
        type: "address",
      },
    ],
    name: "farmers",
    outputs: [
      {
        internalType: "string",
        name: "name",
        type: "string",
      },
      {
        internalType: "string",
        name: "farmLocation",
        type: "string",
      },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "produceId",
        type: "uint256",
      },
    ],
    name: "getProduce",
    outputs: [
      {
        components: [
          {
            internalType: "address",
            name: "currentOwner",
            type: "address",
          },
          {
            internalType: "uint256",
            name: "produceId",
            type: "uint256",
          },
          {
            internalType: "string",
            name: "crop",
            type: "string",
          },
          {
            internalType: "uint256",
            name: "quantity",
            type: "uint256",
          },
          {
            internalType: "string",
            name: "quality",
            type: "string",
          },
          {
            internalType: "string",
            name: "date",
            type: "string",
          },
          {
            components: [
              {
                internalType: "string",
                name: "name",
                type: "string",
              },
              {
                internalType: "string",
                name: "farmLocation",
                type: "string",
              },
            ],
            internalType: "struct AgriSupplyChain.Farmer",
            name: "origin",
            type: "tuple",
          },
          {
            components: [
              {
                internalType: "address",
                name: "newOwner",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "soldPrice",
                type: "uint256",
              },
              {
                internalType: "string",
                name: "date",
                type: "string",
              },
            ],
            internalType: "struct AgriSupplyChain.Transaction[]",
            name: "supplyChain",
            type: "tuple[]",
          },
        ],
        internalType: "struct AgriSupplyChain.Produce",
        name: "",
        type: "tuple",
      },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "",
        type: "uint256",
      },
    ],
    name: "produces",
    outputs: [
      {
        internalType: "address",
        name: "currentOwner",
        type: "address",
      },
      {
        internalType: "uint256",
        name: "produceId",
        type: "uint256",
      },
      {
        internalType: "string",
        name: "crop",
        type: "string",
      },
      {
        internalType: "uint256",
        name: "quantity",
        type: "uint256",
      },
      {
        internalType: "string",
        name: "quality",
        type: "string",
      },
      {
        internalType: "string",
        name: "date",
        type: "string",
      },
      {
        components: [
          {
            internalType: "string",
            name: "name",
            type: "string",
          },
          {
            internalType: "string",
            name: "farmLocation",
            type: "string",
          },
        ],
        internalType: "struct AgriSupplyChain.Farmer",
        name: "origin",
        type: "tuple",
      },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "string",
        name: "name",
        type: "string",
      },
      {
        internalType: "string",
        name: "location",
        type: "string",
      },
    ],
    name: "registerAgent",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "string",
        name: "name",
        type: "string",
      },
      {
        internalType: "string",
        name: "farmLocation",
        type: "string",
      },
    ],
    name: "registerFarmer",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "address",
        name: "",
        type: "address",
      },
    ],
    name: "roles",
    outputs: [
      {
        internalType: "enum AgriSupplyChain.Role",
        name: "",
        type: "uint8",
      },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [
      {
        internalType: "uint256",
        name: "produceId",
        type: "uint256",
      },
      {
        internalType: "address",
        name: "newOwnerAdd",
        type: "address",
      },
      {
        internalType: "uint256",
        name: "soldPrice",
        type: "uint256",
      },
      {
        internalType: "string",
        name: "date",
        type: "string",
      },
    ],
    name: "transferProduce",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
];
    const rpcURL = "https://sepolia.infura.io/v3/71e81c2608894901924d654c4c547be8"; // or Alchemy/any RPC

    const provider = new ethers.providers.JsonRpcProvider(rpcURL);
        const contract = new ethers.Contract(contractAddress, contractABI, provider);
        
    async function loadProduce() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");

      if (!id) {
        document.getElementById("output").innerText = "No produce ID provided in URL.";
        return;
      }

      try {
        

        const details = await contract.getProduce(id);
        console.log(details)

        checkDisplayProduce(details);

        // document.getElementById("output").innerHTML = `
        //   <div class="field"><span class="label">Crop:</span> ${details.crop}</div>
        //   <div class="field"><span class="label">Quantity:</span> ${details.quantity}</div>
        //   <div class="field"><span class="label">Quality:</span> ${details.quality}</div>
        //   <div class="field"><span class="label">Harvest Date:</span> ${details.harvestDate}</div>
        //   <div class="field"><span class="label">Farmer:</span> ${details.farmer}</div>
        //   <div class="field"><span class="label">Location:</span> ${details.location}</div>
        // `;
      } catch (err) {
        console.error(err);
        document.getElementById("output").innerText = "Error loading produce details.";
      }
    }
            function bnToNumber(bn) {
  return Number(bn._hex);
}

async function getAgentName(address) {
  const agent = await contract.agents(address);
  console.log(agent[0]);
  return agent[0];
}

async function checkDisplayProduce(p) {
  const container = document.getElementById("output");
  container.innerHTML = ""; // clear previous content

  let html = `
    <h3>Produce details: </h3>
    <p><strong>Crop:</strong> ${p[2]}</p>
    <p><strong>Quantity:</strong> ${bnToNumber(p[3])}kg</p>
    <p><strong>Quality:</strong> ${p[4]}</p>
    <p><strong>Harvest Date:</strong> ${p[5]}</p>
    
    <h3>Origin: </h3>
    <p><strong>Farmer:</strong> ${p[6][0]}</p>
    <p><strong>Location:</strong> ${p[6][1]}</p>

    
    <h3>Supply Chain:</h3>
  `;

  for (let idx = 0; idx < p[7].length; idx++) {
    const agentData = p[7][idx];
    console.log(agentData);
    const agentName = await getAgentName(agentData[0]); // await works here
    html += `
      <div style="margin-left: 15px; margin-bottom: 10px;">
        <p style="font-size:20px;"><strong>Agent ${
          idx + 1
        }:</strong> ${agentName}</p>
        <p><strong>Bought at:</strong> â‚¹${bnToNumber(agentData[1])}/kg</p>
        <p><strong>Date:</strong> ${agentData[2]}</p>
      </div>
    `;
  }

  container.innerHTML = html;
}
    loadProduce();
  </script>
</body>
</html>
